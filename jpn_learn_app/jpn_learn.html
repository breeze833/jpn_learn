<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <link rel="manifest" href="./jpn_learn_manifest.json">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="referrer" content="no-referrer">
    <title>Êó•Ë™ûÂ≠∏ÁøíÂä©Êâã (50Èü≥ + Âè•Â≠êËß£Êûê)</title>
    <script>
        if ('serviceWorker' in navigator) {
          // register service worker only after page loaded
          window.addEventListener('load', () => {
            navigator.serviceWorker.register('./jpn_learn_sw.js');
            console.log('Service Worker Ë®ªÂÜäÂïüÂãï');
          });
        }
    </script>
    <style>
        /* =========================================
           1. Globals
           ========================================= */
        :root {
            --primary: #2196F3;
            --primary-kana: #ff7eb3;
            --bg: #f5f7fa;
            --header-bg: #ffffff;
            --text-main: #2c3e50;
        }

        * { box-sizing: border-box; }
        
        body {
            font-family: "Microsoft JhengHei", "Helvetica Neue", sans-serif;
            background-color: var(--bg);
            color: var(--text-main);
            margin: 0;
            padding: 0;
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }

        /* =========================================
           2. App Shell (Header & Nav)
           ========================================= */
        header.app-header {
            background: var(--header-bg);
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            position: sticky;
            top: 0;
            z-index: 1000;
            padding: 10px 20px;
        }

        .header-top {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            margin-bottom: 10px;
        }

        .app-title { font-size: 1.2rem; font-weight: bold; color: #333; display: flex; align-items: center; gap: 8px;}
        
        /* ÂÖ®ÂüüÊéßÂà∂ÂçÄ */
        .global-controls {
            display: flex;
            align-items: center;
            gap: 15px;
            font-size: 0.9rem;
            background: #f0f2f5;
            padding: 5px 15px;
            border-radius: 20px;
        }

        .status-pill {
            display: flex;
            align-items: center;
            gap: 6px;
            cursor: pointer;
            padding: 4px 8px;
            border-radius: 4px;
            transition: background 0.2s;
            user-select: none;
        }
        .status-pill:hover { background: #e0e0e0; }
        
        /* Status Indicator */
        .status-indicator { 
            width: 10px; height: 10px; border-radius: 50%; 
            background: #ccc; 
            box-shadow: 0 0 2px rgba(0,0,0,0.2);
            display: none; /* invisible by default */
        }
        .status-indicator.visible { display: inline-block; }
        
        .status-green { background: #4CAF50; box-shadow: 0 0 6px #4CAF50; }
        .status-orange { background: #ff9800; box-shadow: 0 0 6px #ff9800; }
        
        .status-icon { font-size: 1.1rem; }
        .status-text { font-size: 0.85rem; font-weight: bold; color: #555; }

        .speed-control { display: flex; align-items: center; gap: 5px; margin-left: 10px; border-left: 1px solid #ccc; padding-left: 10px;}
        input[type=range] { width: 80px; cursor: pointer; }

        /* Tabs */
        .nav-tabs {
            display: flex;
            justify-content: center;
            gap: 20px;
            border-bottom: 1px solid #eee;
        }

        .tab-btn {
            padding: 10px 20px;
            border: none;
            background: none;
            font-size: 1rem;
            color: #777;
            cursor: pointer;
            position: relative;
            font-weight: bold;
        }

        .tab-btn.active { color: var(--primary); }
        .tab-btn.active::after {
            content: ''; position: absolute; bottom: -1px; left: 0; width: 100%; height: 3px; background: var(--primary);
        }
        
        .tab-btn[data-target="view-kana"].active { color: var(--primary-kana); }
        .tab-btn[data-target="view-kana"].active::after { background: var(--primary-kana); }

        /* =========================================
           3. View Containers
           ========================================= */
        main { flex: 1; padding: 20px; width: 100%; max-width: 1000px; margin: 0 auto; }
        .view-section { display: none; animation: fadeIn 0.3s ease; }
        .view-section.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

        /* =========================================
           4. View A: 50Èü≥
           ========================================= */
        .kana-controls { text-align: center; margin-bottom: 20px; }
        .kana-toggle-btn {
            padding: 6px 16px; border: 2px solid var(--primary-kana); background: white; color: var(--primary-kana);
            border-radius: 20px; cursor: pointer; font-weight: bold; margin: 0 5px; transition: 0.2s;
        }
        .kana-toggle-btn.active { background: var(--primary-kana); color: white; }

        .grid-container {
            display: grid; grid-template-columns: repeat(auto-fit, minmax(60px, 1fr)); 
            gap: 10px; max-width: 600px; margin: 0 auto;
        }
        @media(min-width: 500px) { .grid-container { grid-template-columns: repeat(5, 1fr); } }

        .char-card {
            background: white; border-radius: 10px; aspect-ratio: 1;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05); cursor: pointer; transition: transform 0.2s;
            border: 1px solid transparent;
        }
        .char-card:hover { transform: translateY(-3px); border-color: var(--primary-kana); box-shadow: 0 4px 8px rgba(0,0,0,0.1); }
        .char-main { font-size: 1.8rem; font-weight: bold; color: #333; }
        .char-sub { font-size: 0.8rem; color: #999; }
        .empty-cell { visibility: hidden; pointer-events: none; }

        /* Modal */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.6); backdrop-filter: blur(2px);
            display: flex; justify-content: center; align-items: center;
            opacity: 0; pointer-events: none; transition: opacity 0.3s; z-index: 2000;
        }
        .modal-overlay.open { opacity: 1; pointer-events: auto; }
        .modal-content {
            background: white; padding: 25px; border-radius: 16px; width: 90%; max-width: 320px;
            text-align: center; position: relative; box-shadow: 0 10px 25px rgba(0,0,0,0.2);
        }
        .close-btn { position: absolute; top: 10px; right: 15px; font-size: 1.8rem; cursor: pointer; color: #aaa; }
        
        /* stroke area */
        .stroke-container {
            width: 150px; height: 150px; background: #fff; border: 2px dashed #eee;
            border-radius: 8px; margin: 15px auto; position: relative; display: flex; align-items: center; justify-content: center;
        }
        .stroke-img { max-width: 100%; max-height: 100%; object-fit: contain; z-index: 2; display: none; }
        .loader { border: 3px solid #f3f3f3; border-top: 3px solid var(--primary-kana); border-radius: 50%; width: 24px; height: 24px; animation: spin 1s linear infinite; position: absolute;}
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        /* error message, invisible by default */
        #img-error { display: none; font-size: 0.8rem; color: #999; }

        .play-btn-kana {
            background: var(--primary-kana); color: white; border: none; padding: 10px 30px;
            border-radius: 25px; font-size: 1rem; cursor: pointer; display: inline-flex; align-items: center; gap: 8px;
            box-shadow: 0 4px 10px rgba(255, 126, 179, 0.3); margin-top: 10px;
        }
        .play-btn-kana:hover { opacity: 0.9; }
        .mnemonic { margin-top: 15px; font-size: 0.9rem; color: #555; background: #fff5f8; padding: 10px; border-radius: 6px; text-align: left; border-left: 3px solid var(--primary-kana); }

        /* =========================================
           5. View B: Âè•Â≠êËß£Êûê
           ========================================= */
        .sentence-input-area { width: 100%; height: 100px; font-size: 16px; padding: 12px; border: 2px solid #ddd; border-radius: 8px; margin-bottom: 15px; resize: vertical; }
        .btn-toolbar { display: flex; flex-wrap: wrap; gap: 10px; margin-bottom: 20px; }
        .action-btn {
            padding: 8px 16px; font-size: 14px; cursor: pointer; color: white; border: none; border-radius: 5px; 
            display: flex; align-items: center; gap: 6px; transition: opacity 0.2s;
        }
        .action-btn:hover { opacity: 0.9; }
        .action-btn:disabled { background-color: #ccc !important; cursor: not-allowed; }
        .btn-blue { background-color: #2196F3; } 
        .btn-green { background-color: #4CAF50; } 
        .btn-orange { background-color: #ff9800; } 
        .btn-red { background-color: #f44336; }

        #sentence-result { display: flex; flex-wrap: wrap; align-items: flex-end; row-gap: 24px; min-height: 100px;}
        .token { 
            font-size: 24px; color: #333; border-bottom: 2px solid #ddd; margin-right: 12px; padding: 2px 4px; 
            border-radius: 4px; cursor: pointer; position: relative; transition: all 0.2s; 
        }
        .token:hover { background-color: #e3f2fd; border-bottom-color: #2196F3; }
        .token.speaking { background-color: #E91E63 !important; color: white !important; border-bottom-color: #880E4F !important; transform: scale(1.1); z-index: 5; }
        .token.speaking rt { color: white; opacity: 1; }
        .speaker-icon { 
            display: none; position: absolute; top: -20px; right: -5px; font-size: 12px; 
            background-color: white; color: #333; border: 1px solid #ccc; border-radius: 50%; 
            width: 20px; height: 20px; text-align: center; line-height: 20px; z-index: 10; 
        }
        .token:hover .speaker-icon { display: block; }
        .token[data-pos="Ë®òÂè∑"] { border-bottom: none; cursor: default; }
        .token[data-pos="Ë®òÂè∑"]:hover { background: none; }
        .token[data-pos="Ë®òÂè∑"] .speaker-icon { display: none !important; }
        
        rt { font-size: 12px; color: #d32f2f; opacity: 0; transition: opacity 0.3s; user-select: none; }
        .token:hover rt, .token.active rt { opacity: 1; }
        
        .sys-msg { font-size: 13px; color: #666; margin-top: 5px; font-style: italic;}

        @media (max-width: 600px) {
            .header-top { flex-direction: column; gap: 10px; align-items: flex-start; }
            .global-controls { width: 100%; justify-content: space-between; }
        }
    </style>
</head>
<body>

    <header class="app-header">
        <div class="header-top">
            <div class="app-title">üáØüáµ Êó•Ë™ûÂ≠∏ÁøíÂä©Êâã</div>
            
            <div class="global-controls">
                <div class="status-pill" onclick="AudioManager.toggleEngineMode()" title="ÈªûÊìäÂàáÊèõÊú¨Âú∞/ÈÅ†Á´ØÁôºÈü≥">
                    <span id="global-mode-icon" class="status-icon">üíª</span>
                    
                    <span id="global-mode-text" class="status-text">ÂÅµÊ∏¨‰∏≠...</span>
                    
                    <div id="global-status-indicator" class="status-indicator"></div>
                </div>
                
                <div class="speed-control">
                    <span>üê¢</span>
                    <input type="range" id="global-speed" min="0.5" max="2.0" step="0.1" value="1.0" oninput="document.getElementById('spd-val').innerText = this.value + 'x'">
                    <span style="font-size:12px; width:25px;" id="spd-val">1.0x</span>
                </div>
            </div>
        </div>

        <nav class="nav-tabs">
            <button class="tab-btn active" data-target="view-kana" onclick="switchTab('view-kana')">50Èü≥Á∑¥Áøí</button>
            <button class="tab-btn" data-target="view-sentence" onclick="switchTab('view-sentence')">Âè•Â≠êËß£Êûê</button>
        </nav>
    </header>

    <main>
        <section id="view-kana" class="view-section active">
            <div class="kana-controls">
                <button class="kana-toggle-btn active" id="btn-mode-hira" onclick="KanaApp.setMode('hira')">Âπ≥ÂÅáÂêç</button>
                <button class="kana-toggle-btn" id="btn-mode-kata" onclick="KanaApp.setMode('kata')">ÁâáÂÅáÂêç</button>
            </div>
            
            <div class="grid-container" id="kana-grid"></div>
            
            <div class="modal-overlay" id="kana-modal" onclick="KanaApp.closeModal(event)">
                <div class="modal-content" onclick="event.stopPropagation()">
                    <span class="close-btn" onclick="KanaApp.closeModal()">&times;</span>
                    
                    <div style="margin-bottom: 10px;">
                        <div style="font-size: 3.5rem; color: var(--primary-kana); line-height: 1.2;" id="m-char"></div>
                        <div style="font-size: 1.2rem; font-weight: bold; color: #333;" id="m-romaji"></div>
                    </div>
                    
                    <div class="stroke-container">
                        <div class="loader" id="img-loader"></div>
                        <img id="stroke-img" class="stroke-img" alt="Á≠ÜÈ†Ü" onload="KanaApp.onImgLoad()" onerror="KanaApp.onImgError()">
                        <div id="img-error">ÁÑ°ÂΩ±ÂÉè</div>
                    </div>

                    <button class="play-btn-kana" onclick="KanaApp.playCurrentChar()">
                        üîä ËÅΩÁôºÈü≥
                    </button>

                    <div class="mnemonic" id="m-note"></div>
                </div>
            </div>
            <div style="text-align: center; margin-top: 30px; font-size: 12px; color: #ccc;">ÂΩ±ÂÉè‰æÜÊ∫ê: Wikimedia Commons</div>
        </section>

        <section id="view-sentence" class="view-section">
            <textarea id="input-text" class="sentence-input-area" placeholder="Ë´ãËº∏ÂÖ•Êó•ÊñáÂè•Â≠ê...">‰ªäÊó•„ÅÆÂ§©Ê∞ó„ÅØ„Å®„Å¶„ÇÇ„ÅÑ„ÅÑ„Åß„Åô„Å≠„ÄÇ</textarea>
            
            <div class="btn-toolbar">
                <button onclick="SentenceApp.tokenize()" class="action-btn btn-blue" id="btn-parse" disabled><span>üîç</span> Ëß£Êûê</button>
                <button onclick="SentenceApp.playFull()" class="action-btn btn-green"><span>üîä</span> Êï¥Âè•</button>
                <button onclick="SentenceApp.playSeq()" class="action-btn btn-orange" id="btn-seq" disabled><span>‚ñ∂Ô∏è</span> ÈÄêË©û</button>
                <button onclick="AudioManager.stopAll()" class="action-btn btn-red" id="btn-stop" disabled><span>‚èπ</span> ÂÅúÊ≠¢</button>
            </div>

            <div id="dic-status" class="sys-msg">Ê≠£Âú®Ê∫ñÂÇôÂ≠óÂÖ∏...</div>
            <div id="sentence-result"></div>
        </section>
    </main>

    <audio id="tts-player"></audio>
    <script src="https://cdn.jsdelivr.net/npm/kuromoji@0.1.2/build/kuromoji.js"></script>

    <script>
        /**
         * =========================================================================
         * 1. AudioManager (Core Speech Service)
         * =========================================================================
         */
        const AudioManager = {
            // Proxy on localhost
            PROXY_URL: "http://localhost:3000/tts",
			PROXY_CHECK_URL: "http://localhost:3000/ready",
            
            isProxyAvailable: false,
            isRemoteMode: false,
            localVoice: null,
            audioPlayer: document.getElementById('tts-player'),
            currentPlayId: 0,
            
            // Timeout for voice engine check, to avoid redundant output
            voiceCheckTimeout: null,

            ui: {
                indicator: document.getElementById('global-status-indicator'),
                icon: document.getElementById('global-mode-icon'),
                text: document.getElementById('global-mode-text'),
                speed: document.getElementById('global-speed'),
                stopBtn: document.getElementById('btn-stop')
            },

            cache: {
                dbName: "JP_TTS_Cache", storeName: "audio_files", dbVersion: 1, maxSize: 200,
                async open() {
                    return new Promise((resolve, reject) => {
                        const r = indexedDB.open(this.dbName, this.dbVersion);
                        r.onupgradeneeded = (e) => {
                            const db = e.target.result;
                            if(!db.objectStoreNames.contains(this.storeName)) {
                                db.createObjectStore(this.storeName, { keyPath: "text" }).createIndex("timestamp", "timestamp");
                            }
                        };
                        r.onsuccess = (e) => resolve(e.target.result);
                        r.onerror = (e) => reject(e);
                    });
                },
                async get(text) {
                    try {
                        const db = await this.open();
                        return new Promise(r => {
                            const req = db.transaction(this.storeName, "readwrite").objectStore(this.storeName).get(text);
                            req.onsuccess = () => {
                                if(req.result) {
                                    req.result.timestamp = Date.now();
                                    db.transaction(this.storeName, "readwrite").objectStore(this.storeName).put(req.result);
                                    r(req.result.blob);
                                } else r(null);
                            };
                            req.onerror = () => r(null);
                        });
                    } catch { return null; }
                },
                async put(text, blob) {
                    try {
                        const db = await this.open();
                        const store = db.transaction(this.storeName, "readwrite").objectStore(this.storeName);
                        store.put({ text, blob, timestamp: Date.now() });
                    } catch {}
                }
            },

            init() {
                // 1. detect Proxy (delayed execution)
                setTimeout(() => this.checkProxy(), 800);

                // 2. detect local speech engine (Web Speech API)
                // register event listener: triggered when Android language pack is loaded
                if (window.speechSynthesis.onvoiceschanged !== undefined) {
                    window.speechSynthesis.onvoiceschanged = () => this.detectLocalVoice(false);
                }
                
                // check local speech engine (for PC)
                this.detectLocalVoice(false);

                // 3. timeout for final check (for Android)
                // Android takes time to finish the on-demand language pack loading
                // Wait for 2.5s and check whether the local engine is usable
                this.voiceCheckTimeout = setTimeout(() => {
                    this.detectLocalVoice(true);
                }, 2500);
            },

            async checkProxy() {
                try {
                    const controller = new AbortController();
                    const timeoutId = setTimeout(() => controller.abort(), 1500);
                    const res = await fetch(`${this.PROXY_CHECK_URL}`, { method: 'GET', signal: controller.signal });
                    clearTimeout(timeoutId);
                    
                    if (res.ok) {
                        this.isProxyAvailable = true;
                    } else {
                        this.isProxyAvailable = false;
                    }
                } catch (e) {
                    this.isProxyAvailable = false; 
                }
                this.updateUI();
            },
            
            // forceDecision: ÊòØÂê¶ÁÇ∫ÈÄæÊôÇÂº∑Âà∂Âà§ÂÆö
            detectLocalVoice(forceDecision) {
                const voices = window.speechSynthesis.getVoices();
                
                // Case A: browser is loading language pack (empty array)Ôºåand not timeout -> keep waitingÔºådon't switch
                if (voices.length === 0 && !forceDecision) {
                    // keep current selection (UI È°ØÁ§∫ÂÅµÊ∏¨‰∏≠...)
                    return;
                }

                // Case B: language pack is loaded OR timeout (have to make the decision)
                
                // search for the Japanese voice support
                const jaVoice = voices.find(v => v.lang === 'ja-JP') || voices.find(v => v.lang.startsWith('ja'));
                
                if (jaVoice) {
                    // ‚úÖ Found! Use local voice engine
                    this.localVoice = jaVoice;
                    this.isRemoteMode = false;
                    
                    // If not timeout, clear the timer (avoid unnecessary detection)
                    if (this.voiceCheckTimeout) {
                        clearTimeout(this.voiceCheckTimeout);
                        this.voiceCheckTimeout = null;
                    }
                } else {
                    // ‚ùå Not found (not available or timeout) -> switch to remote engine
                    this.localVoice = null;
                    this.isRemoteMode = true;
                }

                this.updateUI();
            },

            toggleEngineMode() {
                this.isRemoteMode = !this.isRemoteMode;
                this.updateUI();
            },

            updateUI() {
                this.ui.indicator.className = 'status-indicator'; 
                
                if (this.isRemoteMode) {
                    this.ui.icon.textContent = '‚òÅÔ∏è';
                    this.ui.indicator.classList.add('visible'); 
                    
                    if (this.isProxyAvailable) {
                        this.ui.text.innerHTML = `ÈÅ†Á´Ø (Google)`;
                    } else {
                        this.ui.text.innerHTML = `ÈÅ†Á´Ø (Google) <small style="opacity:0.7">ÁÑ°Âø´Âèñ</small>`;
                    }
                } else {
                    this.ui.icon.textContent = 'üíª';
                    this.ui.indicator.classList.remove('visible'); 
                    if (this.localVoice) {
                        this.ui.text.innerHTML = `Êú¨Âú∞ (${this.localVoice.name.substring(0, 10)}...)`;
                    } else {
                        this.ui.text.innerHTML = `Êú¨Âú∞ (È†êË®≠)`;
                    }
                }
            },

            setLight(color) { 
                if (!this.isRemoteMode) return;
                this.ui.indicator.className = 'status-indicator visible';
                if(color === 'green') this.ui.indicator.classList.add('status-green');
                else if(color === 'orange') this.ui.indicator.classList.add('status-orange');
            },

            stopAll() {
                this.currentPlayId++; 
                if(this.ui.stopBtn) this.ui.stopBtn.disabled = true;
                
                this.audioPlayer.oncanplay = null;
                this.audioPlayer.onended = null;
                this.audioPlayer.onerror = null;

                this.audioPlayer.pause();
                try { this.audioPlayer.currentTime = 0; } catch(e) {}
                
                window.speechSynthesis.cancel();
                this.setLight('gray');
                
                if (typeof SentenceApp !== 'undefined') {
                    SentenceApp.stopSequenceUI();
                }
            },

            play(text, onComplete) {
                const myRequestId = ++this.currentPlayId;
                const speed = parseFloat(this.ui.speed.value);
                
                if (!this.isRemoteMode) {
                    window.speechSynthesis.cancel();
                    const utter = new SpeechSynthesisUtterance(text);
                    utter.lang = 'ja-JP';
                    if (this.localVoice) utter.voice = this.localVoice;
                    utter.rate = speed;
                    utter.onend = () => { 
                        if(this.currentPlayId === myRequestId && onComplete) onComplete(); 
                    };
                    utter.onerror = (e) => { 
                        console.error(e); 
                        if(this.currentPlayId === myRequestId && onComplete) onComplete(); 
                    };
                    window.speechSynthesis.speak(utter);
                } else {
                    this.playRemote(text, speed, onComplete, myRequestId);
                }
            },

            async playRemote(text, speed, onComplete, requestId) {
                if (requestId !== this.currentPlayId) return;

                const doPlay = (url) => {
                    if (requestId !== this.currentPlayId) return;
                    this.audioPlayer.src = url;

                    this.audioPlayer.oncanplay = () => {
                        if (requestId !== this.currentPlayId) return;
                        this.audioPlayer.playbackRate = speed;
                        this.audioPlayer.play().catch(() => {
                            if (requestId === this.currentPlayId) {
                                this.setLight('gray'); if(onComplete) onComplete();
                            }
                        });
                    };
                    this.audioPlayer.onended = () => {
                        if (requestId !== this.currentPlayId) return;
                        this.setLight('gray'); if(onComplete) onComplete();
                    };
                    this.audioPlayer.onerror = () => {
                        if (requestId !== this.currentPlayId) return;
                        this.setLight('gray'); if(onComplete) onComplete();
                    };
                };

                const cachedBlob = await this.cache.get(text);
                if (requestId !== this.currentPlayId) return;

                if (cachedBlob) {
                    this.setLight('green');
                    doPlay(URL.createObjectURL(cachedBlob));
                    return;
                }

                this.setLight('orange');
                if (this.isProxyAvailable) {
                    try {
                        const res = await fetch(`${this.PROXY_URL}?q=${encodeURIComponent(text)}`);
                        if (requestId !== this.currentPlayId) return;
                        if (!res.ok) throw new Error();
                        const blob = await res.blob();
                        this.cache.put(text, blob);
                        doPlay(URL.createObjectURL(blob));
                        return;
                    } catch (e) {}
                }

                if (requestId !== this.currentPlayId) return;
                const directUrl = `https://translate.google.com/translate_tts?ie=UTF-8&tl=ja&client=tw-ob&q=${encodeURIComponent(text)}&t=${Date.now()}`;
                doPlay(directUrl);
            }
        };

        /**
         * =========================================================================
         * 2. KanaApp (50Èü≥ÈÇèËºØ)
         * =========================================================================
         */
        const KanaApp = {
            data: [
                { r: 'a', h: '„ÅÇ', k: '„Ç¢', note: '„Äå„ÅÇ„ÄçÈï∑ÂæóÂÉè„ÄåÂÆâ„ÄçÂÖ®ÁöÑÂÆâ„ÄÇ' }, { r: 'i', h: '„ÅÑ', k: '„Ç§', note: '„Äå„ÅÑ„ÄçÂÉèÊº¢Â≠ó„Äå‰ª•„ÄçÁöÑÂ∑¶ÈÇä„ÄÇ' }, { r: 'u', h: '„ÅÜ', k: '„Ç¶', note: '„Äå„ÅÜ„Äç‰∏äÈù¢‰∏ÄÈªûÔºåÂÉèÊ≥®Èü≥„Äå„ÑÖ„Äç‰∏äÈù¢Âä†‰∏ÄÈªû„ÄÇ' }, { r: 'e', h: '„Åà', k: '„Ç®', note: '„Äå„Åà„ÄçÂÉèÊº¢Â≠ó„ÄåÂÖÉ„ÄçÁöÑËçâÂØ´„ÄÇ' }, { r: 'o', h: '„Åä', k: '„Ç™', note: '„Äå„Åä„ÄçÂÉèÂú®ÊâìÈ´òÁàæÂ§´ÁêÉÁöÑÂßøÂã¢„ÄÇ' },
                { r: 'ka', h: '„Åã', k: '„Ç´', note: '„Äå„Åã„ÄçÂ∞±ÊòØ„ÄåÂä†„ÄçÊ≤πÁöÑÂä†„ÄÇ' }, { r: 'ki', h: '„Åç', k: '„Ç≠', note: '„Äåki„ÄçÂÉèÂêâ‰ªñÁöÑÁê¥È†∏„ÄÇ' }, { r: 'ku', h: '„Åè', k: '„ÇØ', note: '„Äåku„ÄçÂÉèÈ≥•ÁöÑÂò¥Â∑¥ (Cuckoo)„ÄÇ' }, { r: 'ke', h: '„Åë', k: '„Ç±', note: '„Äåke„ÄçÂÉèÊº¢Â≠ó„ÄåË®à„ÄçÁöÑÂ∑¶ÈÇä„ÄÇ' }, { r: 'ko', h: '„Åì', k: '„Ç≥', note: '„Äå„Åì„ÄçÊòØÂÖ©Ê¢ùÁ∑öÔºåÂÉè„ÄåÂ∑±„Äç„ÄÇ' },
                { r: 'sa', h: '„Åï', k: '„Çµ', note: '„Äå„Åï„ÄçÂÉèÊÆ∫Ê∞£ÁöÑ„ÄåÊÆ∫„ÄçËçâÂØ´„ÄÇ' }, { r: 'shi', h: '„Åó', k: '„Ç∑', note: '„Äå„Åó„ÄçÂÉèÂê∏ÁÆ°ÁöÑÂΩ¢ÁãÄ„ÄÇ' }, { r: 'su', h: '„Åô', k: '„Çπ', note: '„Äåsu„ÄçË£°Èù¢ÊúâÂÄãÂúàÂúàÔºåÂÉèÁõ™Èû¶ÈüÜ„ÄÇ' }, { r: 'se', h: '„Åõ', k: '„Çª', note: '„Äåse„ÄçÂÉè‰∏ñÁïåÁöÑ„Äå‰∏ñ„Äç„ÄÇ' }, { r: 'so', h: '„Åù', k: '„ÇΩ', note: '„Äåso„ÄçÂÉèZ‰∏äÈù¢Âä†‰∏ÄÈªû„ÄÇ' },
                { r: 'ta', h: '„Åü', k: '„Çø', note: '„Äåta„ÄçÂÉèÊº¢Â≠ó„ÄåÂ§™„Äç„ÄÇ' }, { r: 'chi', h: '„Å°', k: '„ÉÅ', note: '„Äåchi„ÄçÂÉèÊï∏Â≠ó„Äå5„ÄçÔºå‰πüÂÉè‰∏É„ÄÇ' }, { r: 'tsu', h: '„Å§', k: '„ÉÑ', note: '„Äåtsu„ÄçÂÉèÂà∫ËùüÁöÑÂà∫ÔºåÊàñÊòØÊµ∑ÂòØ (Tsunami)„ÄÇ' }, { r: 'te', h: '„Å¶', k: '„ÉÜ', note: '„Äåte„ÄçÂÉèÂ±ïÈñãÁöÑÊâã„ÄÇ' }, { r: 'to', h: '„Å®', k: '„Éà', note: '„Äåto„ÄçÂÉèÂÖîÂ≠êÁöÑËÄ≥Êúµ„ÄÇ' },
                { r: 'na', h: '„Å™', k: '„Éä', note: '„Äåna„ÄçÂÉè„ÄåÂ•à„ÄçËâØÁöÑÂ•à„ÄÇ' }, { r: 'ni', h: '„Å´', k: '„Éã', note: '„Äåni„ÄçÂ∞±ÊòØÊº¢Â≠ó„Äå‰∫å„ÄçÂä†‰∏ä‰∏ÄË±é„ÄÇ' }, { r: 'nu', h: '„Å¨', k: '„Éå', note: '„Äånu„ÄçÂÉèÂ•¥Èö∏ÁöÑ„ÄåÂ•¥„Äç„ÄÇ' }, { r: 'ne', h: '„Å≠', k: '„Éç', note: '„Äåne„ÄçÁµêÂ∞æÊúâÂÄãÂúàÔºåÂÉèË≤ìÁöÑÂ∞æÂ∑¥ (Neko)„ÄÇ' }, { r: 'no', h: '„ÅÆ', k: '„Éé', note: '„Äåno„ÄçÂ∞±ÂÉèÁ¶ÅÊ≠¢Ê®ôË™å„ÄÇ' },
                { r: 'ha', h: '„ÅØ', k: '„Éè', note: '„Äåha„ÄçÂÉèÂìàÊ∞£ÁöÑÂãï‰Ωú„ÄÇ' }, { r: 'hi', h: '„Å≤', k: '„Éí', note: '„Äåhi„ÄçÂÉè‰∏ÄÂÄã‰∫∫Âú®Á¨ëÂòªÂòªÁöÑÂò¥Âûã„ÄÇ' }, { r: 'fu', h: '„Åµ', k: '„Éï', note: '„Äåfu„ÄçÂÉèÂØåÂ£´Â±±„ÄÇ' }, { r: 'he', h: '„Å∏', k: '„Éò', note: '„Äåhe„ÄçÂ∞±ÊòØÊåáËëóÈÅ†Êñπ (Hey!)„ÄÇ' }, { r: 'ho', h: '„Åª', k: '„Éõ', note: '„Äåho„ÄçÂÉè‰øùË≠∑ÁöÑ„Äå‰øù„Äç„ÄÇ' },
                { r: 'ma', h: '„Åæ', k: '„Éû', note: '„Äåma„ÄçÂÉèÂ™ΩÂ™ΩÊä±Â∞èÂ≠©„ÄÇ' }, { r: 'mi', h: '„Åø', k: '„Éü', note: '„Äåmi„ÄçÂÉèÁæéÂ¶ôÁöÑ„ÄåÁæé„Äç‰∏ãÈù¢„ÄÇ' }, { r: 'mu', h: '„ÇÄ', k: '„É†', note: '„Äåmu„ÄçÂÉèÁâõÂú®Âè´ Moo~„ÄÇ' }, { r: 'me', h: '„ÇÅ', k: '„É°', note: '„Äåme„ÄçÂÉèÈ∫µÊ¢ùÁöÑ„ÄåÈ∫µ„ÄçÂ•≥Â≠óÈÇä„ÄÇ' }, { r: 'mo', h: '„ÇÇ', k: '„É¢', note: '„Äåmo„ÄçÂÉèÊØõÊØõËü≤ÁöÑ„ÄåÊØõ„Äç„ÄÇ' },
                { r: 'ya', h: '„ÇÑ', k: '„É§', note: '„Äåya„ÄçÂÉèÈ¥®Â≠êÁöÑÈ¥®„ÄÇ' }, { empty: true }, { r: 'yu', h: '„ÇÜ', k: '„É¶', note: '„Äåyu„ÄçÂÉèÁî±‰æÜÁöÑ„ÄåÁî±„ÄçËçâÂØ´„ÄÇ' }, { empty: true }, { r: 'yo', h: '„Çà', k: '„É®', note: '„Äåyo„ÄçÂÉèÁé©Ê∫úÊ∫úÁêÉ Yo-Yo„ÄÇ' },
                { r: 'ra', h: '„Çâ', k: '„É©', note: '„Äåra„ÄçÂÉèÈ¶¨Ê°∂Ëìã (Lavatory)„ÄÇ' }, { r: 'ri', h: '„Çä', k: '„É™', note: '„Äåri„ÄçÂÉèÂà©ÁõäÁöÑ„ÄåÂà©„ÄçÂè≥ÈÇä„ÄÇ' }, { r: 'ru', h: '„Çã', k: '„É´', note: '„Äåru„ÄçÂ∞æÂ∑¥ÊúâÂúàÂúà (Loop)„ÄÇ' }, { r: 're', h: '„Çå', k: '„É¨', note: '„Äåre„ÄçÂÉèÁ¶ÆË≤åÁöÑ„ÄåÁ¶Æ„ÄçÂè≥ÈÇä„ÄÇ' }, { r: 'ro', h: '„Çç', k: '„É≠', note: '„Äåro„ÄçÂÉè„Äå„Çã„Äç‰ΩÜÊ≤íÊúâÂúàÂúà„ÄÇ' },
                { r: 'wa', h: '„Çè', k: '„ÉØ', note: '„Äåwa„ÄçÂÉèÂìáÂìáÂ§ßÂì≠ÁöÑÊ®£Â≠ê„ÄÇ' }, { empty: true }, { empty: true }, { empty: true }, { r: 'wo', h: '„Çí', k: '„É≤', note: '„Äåwo„ÄçËÆÄÈü≥Âêå oÔºåÈÄöÂ∏∏Áï∂Âä©Ë©û„ÄÇ' },
                { r: 'n', h: '„Çì', k: '„É≥', note: '„Äån„ÄçÂÉèËã±ÊñáÊâãÂØ´ÁöÑ n„ÄÇ' }, { empty: true }, { empty: true }, { empty: true }, { empty: true }
            ],
            currentMode: 'hira',
            currentItem: null,

            init() {
                this.renderGrid();
            },

            setMode(mode) {
                this.currentMode = mode;
                document.getElementById('btn-mode-hira').classList.toggle('active', mode === 'hira');
                document.getElementById('btn-mode-kata').classList.toggle('active', mode === 'kata');
                this.renderGrid();
            },

            renderGrid() {
                const container = document.getElementById('kana-grid');
                container.innerHTML = '';
                this.data.forEach(item => {
                    const card = document.createElement('div');
                    if (item.empty) {
                        card.className = 'char-card empty-cell';
                    } else {
                        card.className = 'char-card';
                        card.innerHTML = `<div class="char-main">${this.currentMode === 'hira' ? item.h : item.k}</div><div class="char-sub">${item.r}</div>`;
                        card.onclick = () => this.openModal(item);
                    }
                    container.appendChild(card);
                });
            },

            openModal(item) {
                this.currentItem = item;
                const modal = document.getElementById('kana-modal');
                const mainChar = this.currentMode === 'hira' ? item.h : item.k;
                document.getElementById('m-char').textContent = mainChar;
                document.getElementById('m-romaji').textContent = item.r;
                document.getElementById('m-note').innerHTML = `<b>üí° Ë®òÊÜ∂Ôºö</b>${item.note}`;
                
                const img = document.getElementById('stroke-img');
                const loader = document.getElementById('img-loader');
                const err = document.getElementById('img-error');
                
                img.style.display = 'none'; 
                loader.style.display = 'block'; 
                err.style.display = 'none';
                img.removeAttribute('src'); 
                
                this.fetchWikiImage(mainChar, this.currentMode).then(url => { img.src = url; })
                    .catch((e) => { console.error(e); this.onImgError(); });
                
                modal.classList.add('open');
            },

            closeModal(e) {
                if(e && e.target.closest('.modal-content')) return;
                document.getElementById('kana-modal').classList.remove('open');
                AudioManager.stopAll();
            },

            playCurrentChar() {
                if(!this.currentItem) return;
                const text = this.currentMode === 'hira' ? this.currentItem.h : this.currentItem.k;
                AudioManager.play(text);
            },

            async fetchWikiImage(char, mode) {
                const prefix = mode === 'hira' ? 'Hiragana' : 'Katakana';
                const filename = `File:${prefix}_${char}_stroke_order_animation.gif`;
                const params = new URLSearchParams({
                    action: 'query', titles: filename, prop: 'imageinfo', iiprop: 'url', format: 'json', origin: '*'
                });
                const res = await fetch(`https://commons.wikimedia.org/w/api.php?${params.toString()}`);
                const data = await res.json();
                const pages = data.query.pages;
                const pageId = Object.keys(pages)[0];
                if(pageId === "-1") throw new Error("Image not found");
                return pages[pageId].imageinfo[0].url;
            },

            onImgLoad() {
                document.getElementById('img-loader').style.display = 'none';
                document.getElementById('stroke-img').style.display = 'block';
            },
            onImgError() {
                const img = document.getElementById('stroke-img');
                if (!img.getAttribute('src')) return;
                document.getElementById('img-loader').style.display = 'none';
                document.getElementById('stroke-img').style.display = 'none';
                document.getElementById('img-error').style.display = 'block';
            }
        };

        /**
         * =========================================================================
         * 3. SentenceApp (Âè•Â≠êËß£ÊûêÈÇèËºØ)
         * =========================================================================
         */
        const SentenceApp = {
            tokenizer: null,
            tokens: [],
            isSequencing: false,
            seqIndex: 0,
            currentSeqId: 0,
            
            // Â≠óÂÖ∏‰ΩçÁΩÆ
            CDN_DIC_URL: "https://cdn.jsdelivr.net/npm/kuromoji@0.1.2/dict/",
            LOCAL_DIC_URL: "dict/",

            init() {
                this.initSmartDictionary();
            },

            async initSmartDictionary() {
                const statusDiv = document.getElementById('dic-status');
                
                const protocol = window.location.protocol;
                const isLocalFileMode = (protocol === 'file:');
                
                let targetPath = "";
                let sourceName = "";

                if (isLocalFileMode) {
                    targetPath = this.CDN_DIC_URL;
                    sourceName = "CDN";
                } else {
                    targetPath = this.LOCAL_DIC_URL;
                    sourceName = "Server";
                }

                statusDiv.innerHTML = `Ê≠£Âú®Ê∏¨Ë©¶Â≠óÂÖ∏: ${sourceName}...`;

                const isPathOk = await this.checkPathAccessibility(targetPath);
                
                if (isPathOk) {
                    this.loadKuromoji(targetPath, sourceName);
                } else {
                    console.warn(`Dictionary check failed for ${targetPath}`);
                    
                    if (!isLocalFileMode) {
                        statusDiv.innerHTML = `<span style="color: #d32f2f;">‚ùå Server Â≠óÂÖ∏Ê™îÈÅ∫Â§±<br><small>Server Ê®°Âºè‰∏ã‰∏ç‰ΩøÁî® CDN</small></span>`;
                    } else {
                        statusDiv.innerHTML = `<span style="color: #d32f2f;">‚ùå ÁÑ°Ê≥ïÈÄ£Á∑öËá≥ CDN Â≠óÂÖ∏</span>`;
                    }
                }
            },

            async checkPathAccessibility(baseUrl) {
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 3000); 
                try {
                    const response = await fetch(baseUrl + "base.dat.gz", { method: 'HEAD', signal: controller.signal });
                    clearTimeout(timeoutId);
                    return response.ok;
                } catch (error) {
                    clearTimeout(timeoutId);
                    return false;
                }
            },

            loadKuromoji(path, sourceName) {
                const statusDiv = document.getElementById('dic-status');
                statusDiv.innerHTML = `Ê≠£Âú®‰∏ãËºâÂ≠óÂÖ∏ (${sourceName})...`;
                
                kuromoji.builder({ dicPath: path }).build((err, _tokenizer) => {
                    if (err) {
                        console.error(err);
                        statusDiv.innerHTML = `<span style="color:red">Â≠óÂÖ∏ËºâÂÖ•Â§±Êïó</span>`;
                    } else {
                        this.tokenizer = _tokenizer;
                        statusDiv.innerHTML = `<span style="color:green">‚úÖ Â≠óÂÖ∏Â∞±Á∑í (${sourceName})</span>`;
                        document.getElementById('btn-parse').disabled = false;
                        document.getElementById('btn-seq').disabled = false;
                    }
                });
            },

            tokenize() {
                if (!this.tokenizer) return;
                const text = document.getElementById('input-text').value;
                const resultDiv = document.getElementById('sentence-result');
                resultDiv.innerHTML = '';
                
                const rawTokens = this.tokenizer.tokenize(text);
                
                rawTokens.forEach(token => {
                    const surface = token.surface_form;
                    const readingKata = token.reading || surface;
                    const readingHira = readingKata.replace(/[\u30a1-\u30f6]/g, m => String.fromCharCode(m.charCodeAt(0) - 0x60));
                    const needFuri = (surface !== readingHira && surface !== readingKata);
                    const pos = token.pos;

                    const span = document.createElement('span');
                    span.className = 'token';
                    span.dataset.text = surface; 
                    span.dataset.pos = pos;

                    let html = needFuri ? `<ruby>${surface}<rt>${readingHira}</rt></ruby>` : surface;
                    if(pos !== "Ë®òÂè∑" && surface.trim()) {
                        html += `<span class="speaker-icon" onclick="event.stopPropagation(); AudioManager.play('${surface}')">üîä</span>`;
                        span.onclick = function() { this.classList.toggle('active'); };
                    }
                    span.innerHTML = html;
                    resultDiv.appendChild(span);
                });
                this.tokens = document.querySelectorAll('.token');
            },

            playFull() {
                AudioManager.stopAll();
                const text = document.getElementById('input-text').value;
                if(!text) return;
                document.getElementById('btn-stop').disabled = false;
                AudioManager.play(text, () => { document.getElementById('btn-stop').disabled = true; });
            },

            playSeq() {
                AudioManager.stopAll();
                this.currentSeqId++; 
                if(this.tokens.length === 0) {
                    this.tokenize();
                    if(this.tokens.length === 0) return;
                }
                this.isSequencing = true;
                this.seqIndex = 0;
                document.getElementById('btn-stop').disabled = false;
                this.playNextToken(this.currentSeqId);
            },

            playNextToken(seqId) {
                if (seqId !== this.currentSeqId) return;

                if(!this.isSequencing || this.seqIndex >= this.tokens.length) {
                    this.stopSequenceUI();
                    return;
                }
                const el = this.tokens[this.seqIndex];
                const text = el.dataset.text;
                const pos = el.dataset.pos;

                if (pos === "Ë®òÂè∑" || !text.trim()) {
                    this.seqIndex++; 
                    setTimeout(() => this.playNextToken(seqId), 0); 
                    return;
                }

                el.classList.add('speaking');
                const delay = AudioManager.isRemoteMode ? 100 : 10;
                
                setTimeout(() => {
                    if(!this.isSequencing || seqId !== this.currentSeqId) {
                         el.classList.remove('speaking'); return;
                    }
                    AudioManager.play(text, () => {
                        if (seqId !== this.currentSeqId) {
                            el.classList.remove('speaking'); return;
                        }
                        el.classList.remove('speaking');
                        this.seqIndex++;
                        const spd = parseFloat(document.getElementById('global-speed').value);
                        const gap = AudioManager.isRemoteMode ? 200 : 50;
                        if(this.isSequencing) {
                            setTimeout(() => this.playNextToken(seqId), gap/spd);
                        }
                    });
                }, delay);
            },

            stopSequenceUI() {
                this.isSequencing = false;
                this.currentSeqId++; 
                document.querySelectorAll('.token.speaking').forEach(el => el.classList.remove('speaking'));
                document.getElementById('btn-stop').disabled = true;
            }
        };

        function switchTab(viewId) {
            AudioManager.stopAll();
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.target === viewId);
            });
            document.querySelectorAll('.view-section').forEach(section => {
                section.classList.remove('active');
            });
            document.getElementById(viewId).classList.add('active');
        }

        AudioManager.init();
        KanaApp.init();
        SentenceApp.init(); 

    </script>
</body>
</html>
